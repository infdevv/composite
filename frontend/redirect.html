<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Ad - Composite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
            background: #0d0e0d;
            color: white;
        }
        .warning {
            color: #ff6b6b;
            margin: 20px 0;
        }
        .countdown {
            font-size: 24px;
            color: #f59ddb;
            margin: 20px 0;
        }
        .loading {
            color: #4ecdc4;
        }
        .error {
            color: #ff6b6b;
            background: #ffe0e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <noscript>Please turn JavaScript on to watch ads and earn credits</noscript>
    
    <h1 class="warning">⚠️ Watch an Ad to Earn Credits ⚠️</h1>
    
    <div class="warning">
        <p><strong>Close out of all other sites that the ad opens</strong></p>
        <p>Just stay on the ad site until it lets you click continue</p>
    </div>
    
    <div class="countdown" id="countdown">Preparing to load ad... Please wait 5 seconds</div>
    
    <div class="loading" id="loading" style="display:none;">
        <p>Loading ad from Cuty.io...</p>
    </div>
    
    <div id="status"></div>
    
    <div class="warning">
        <h3>⚠️ Complete the ad to get credits! ⚠️</h3>
        <p><strong>After the ad loads:</strong></p>
        <p>1. Stay on the ad site</p>
        <p>2. Wait for the "Continue" or "Skip" button</p>
        <p>3. Click the button to complete the ad</p>
        <p>4. Come back here to get your credits</p>
    </div>

<script>
let countdown = 5;
let adUrl = null;

function updateCountdown() {
    const countdownElement = document.getElementById("countdown");
    if (countdown > 0) {
        countdownElement.textContent = `Loading ad in ${countdown} seconds...`;
        countdown--;
        setTimeout(updateCountdown, 1000);
    } else {
        loadAd();
    }
}

async function loadAd() {
    document.getElementById("countdown").style.display = "none";
    document.getElementById("loading").style.display = "block";
    
    try {
        // Check if user has a valid key
        const userKey = window.localStorage.getItem("key");
        if (!userKey || userKey === "undefined" || userKey.trim() === "") {
            throw new Error("No valid API key found. Please generate a key first.");
        }
        
        const response = await fetch("/api/getAdUrl", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                url: window.origin + "/rep.html", // Direct to rep.html for credit collection
                key: userKey
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Server returned ${response.status}`);
        }
        
        const data = await response.json();
        adUrl = data.adUrl;
        
        if (!adUrl) {
            throw new Error("Invalid response from server - missing ad URL");
        }
        
        document.getElementById("status").innerHTML = `
            <div class="loading">
                <p>✓ Ad URL generated successfully!</p>
                <p>Opening ad in new tab...</p>
                <p><em>Check your browser's tab bar for the new ad tab</em></p>
            </div>
        `;
        
        // Open ad in new tab and stay on current page
        setTimeout(() => {
            const adWindow = window.open(adUrl, "_blank", "noopener,noreferrer");
            
            if (!adWindow) {
                // Popup blocked, show manual instructions
                document.getElementById("status").innerHTML = `
                    <div class="error">
                        <p>⚠️ Popup blocked! Please allow popups for this site</p>
                        <p>Or <a href="${adUrl}" target="_blank" style="color: #4ecdc4;">click here to open the ad manually</a></p>
                    </div>
                `;
            } else {
                document.getElementById("status").innerHTML = `
                    <div class="loading">
                        <p>✓ Ad opened in new tab!</p>
                        <p>⚠️ IMPORTANT: Do NOT close this page!</p>
                        <p>Complete the ad in the new tab, then return here</p>
                        <p>Come back here after completing the ad to get your credits</p>
                        <br>
                        <p><em>Ad tab: ${adWindow.document.title || 'New Tab'}</em></p>
                    </div>
                `;
            }
        }, 1000);
        
    } catch (error) {
        console.error('Ad loading error:', error);
        document.getElementById("status").innerHTML = `
            <div class="error">
                <p>Error loading ad: ${error.message}</p>
                <p><button onclick="location.reload()" style="margin-top: 10px; padding: 10px; background: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer;">Try Again</button></p>
                <p><a href="/" style="color: #4ecdc4;">← Back to Home</a></p>
            </div>
        `;
    }
}

// Start countdown when page loads
updateCountdown();
</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-X4ZJ7B4GKN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-X4ZJ7B4GKN');
</script>